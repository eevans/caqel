<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
        "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
    <link rel="stylesheet" href="/static/css/style.css" />
    <script type="text/javascript" src="/static/js/jquery.js"></script>

    <script type="text/javascript">
        function displayResults(results) {
            var display = $("#query_results");
            display.empty();
            
            if (results.hasOwnProperty("rows")) {
                var rows = results.rows;
                if (Object.keys(rows).length < 1) {
                    display.append($("<span/>").addClass("message").append("0 results"));
                    return null;
                }
                
                for (row in rows) {
                    display.append($("<span/>").addClass("key").append(row+""));
                    for (col in rows[row]) {
                        var column = rows[row][col]
                        display.append($("<span/>").addClass("column_name").append(column.name));
                        display.append(",");
                        display.append($("<span/>").addClass("column_value").append(column.value));
                        display.append(" ");
                    }
                    display.append($("<br/>"));
                }
            } else if (results.hasOwnProperty("void")) {
                display.append(
                    $("<span/>").addClass("void").append(results["void"]));
            } else if (results.hasOwnProperty("int")) {
                display.append($("<span/>").append(results.int));
            } else if (results.hasOwnProperty("exception")) {
                display.append(
                    $("<span/>").addClass("exception").append(results.exception));
            } else {
                // wtf?
            }
        }
        
        function postQuery(queryString) {
            // Set the spinner image to spinning
            $("#query_results").html($("<center/>").append(
                $("<img/>").attr("src", "/static/images/dark-loader.gif")
                    .attr("border", "0")
            ));
            var csrf_token = $('#csrf_token >div >input').attr("value");
            var data = {}
            data["post_data"] = queryString;
            data["csrfmiddlewaretoken"] = csrf_token;
            
            var ret = $.post("query/", data, displayResults, "json")
            ret.success(
                function() {
                    if (data["post_data"].match(/(create|drop)/i)) {
                        displaySchema();
                    }
                });
            ret.error(function(jqXHR, textStatus, errorThrown) {
                console.log("Query failed: " + textStatus + ": " + errorThrown);
            });
            
            var history = $("<span/>").addClass("command").append(queryString);
            history.hide();
            $("#history").prepend(history.append("<br/>"));
            history.fadeIn(700);
        }
        
        $(document).ready(function() {
            $('#query_form').submit(function(event) {
                event.preventDefault(); // cancel the default action
                var form = this;
                postQuery($(form).find('textarea[name=query]').val());
            });
        });
    </script>
</head>
<body>

<div id="header"><span class="logo"><img src="/static/images/cql.png" border="0" /></span></div>
<div id="container">
    {% include "schema.html" %}
    
    <div id="query_box">
        <h2>Query Results</h2>
        <div id="query_results">Enter a query below and click Submit.</div>
        
        <form action="query/" method="post" id="query_form">
            <div>
                <textarea name="query" rows="4" cols="80" tabindex="1"></textarea>
            </div>
            <div>
                <input type="submit" value="Submit" tabindex="2" />
                <input type="button" value="Reset" tabindex="3"
                       onclick="$('#query_form').find('textarea[name=query]').val('')" />
            </div>
        </form>
        <div id="history"></div>
    </div>

    <div id="csrf_token">{% csrf_token %}</div>
</div>
<div id="footer"></div>

</body>
</html>
